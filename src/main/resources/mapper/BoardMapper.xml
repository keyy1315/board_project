<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.board_project.mapper.BoardMapper">
<!--    <select id="findAll" resultType="Board">-->
<!--        SELECT * FROM bt_tb_board-->
<!--    </select>-->

<!-- searchFilterDTO.searchCode[all(전체), writer_nm(작성자명), title(제목), cont(내용), tiCont(제목+내용)]-->
    <select id="countBoard" parameterType="BoardListRequestDTO" resultType="int">
        SELECT COUNT(*) FROM bt_tb_board
        WHERE 1=1
        <if test="categoryCode != null">
            AND category_cd = #{categoryCode}
        </if>
        <if test="search != null">
            <choose>
                <when test="searchCode eq 'all'">
                    AND CONCAT(title, cont, writer_nm) LIKE CONCAT('%', #{search}, '%')
                </when>
                <when test="searchCode eq 'tiCont'">
                    AND CONCAT(title, cont) LIKE CONCAT('%', #{search}, '%')
                </when>
                <otherwise>
                    AND
                    <choose>
                        <when test="searchCode eq 'title'"> title </when>
                        <when test="searchCode eq 'cont'"> cont </when>
                        <when test="searchCode eq 'writer_nm'"> writer_nm </when>
                        <otherwise> title </otherwise>
                    </choose>
                    LIKE CONCAT('%', #{search}, '%')
                </otherwise>
            </choose>
        </if>
    </select>


    <select id="findWithFilter" parameterType="BoardListRequestDTO" resultType="Board">
        SELECT * FROM bt_tb_board
        WHERE 1=1
        <if test="categoryCode != null">
            AND category_cd = #{categoryCode}
        </if>
        <if test="search != null">
            <choose>
                <when test="searchCode eq 'all'">
                    AND CONCAT(title, cont, writer_nm) LIKE CONCAT('%', #{search}, '%')
                </when>
                <when test="searchCode eq 'tiCont'">
                    AND CONCAT(title, cont) LIKE CONCAT('%', #{search}, '%')
                </when>
                <otherwise>
                    AND
                    <choose>
                        <when test="searchCode eq 'title'"> title </when>
                        <when test="searchCode eq 'cont'"> cont </when>
                        <when test="searchCode eq 'writer_nm'"> writer_nm </when>
                        <otherwise> title </otherwise>
                    </choose>
                    LIKE CONCAT('%', #{search}, '%')
                </otherwise>
            </choose>
        </if>
        <if test="sortCode != null">
            ORDER BY
            <choose>
                <when test="sortCode eq 'reg_dt'"> IFNULL(mod_dt, reg_dt) DESC </when>
                <otherwise> ${sortCode} DESC </otherwise>
            </choose>
        </if>
        LIMIT #{size} OFFSET #{offset}
    </select>
    <insert id="saveBoard" parameterType="WriteBoardRequestDTO" useGeneratedKeys="true" keyProperty="boardNo">
        INSERT INTO bt_tb_board
        (category_cd, title, cont, writer_nm, password, view_cnt, reg_dt)
        VALUES
        (#{ct_cd}, #{title}, #{cont}, #{writer_nm}, #{password}, 0, NOW())
    </insert>
    <update id="updateBoard" parameterType="WriteBoardRequestDTO">
        UPDATE bt_tb_board
        SET title = #{title}, cont = #{cont}, writer_nm = #{writer_nm}, mod_dt = NOW(), category_cd = #{ct_cd}
        WHERE board_no = #{boardNo}
    </update>
    <select id="findBoard" parameterType="int">
        SELECT * FROM bt_tb_board
        WHERE board_no = #{boardNo}
    </select>
    <update id="IncrementViewCnt" parameterType="int">
        UPDATE bt_tb_board
        SET view_cnt = view_cnt + 1
        WHERE board_no = #{boardNo}
    </update>
    <delete id="deleteBoard" parameterType="int">
        DELETE FROM bt_tb_board
        WHERE board_no = #{BoardNo}
    </delete>
    <select id="getBoardPassword" parameterType="int" resultType="string">
        SELECT password FROM bt_tb_board
        WHERE board_no = #{BoardNo}
    </select>
</mapper>